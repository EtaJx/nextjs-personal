```yaml
title: 关于一次NODE项目的总结
date: 2017-02-14 22:38:48
tags:
- node
- express
categorise:
- node
```

#### 终于又更新
是的，很久没更新了，除了懒（(*≧▽≦*)）的原因之外，还在忙这个第一次接手的完整的node项目，肝了两个月，终于上线了（算上开发和测试）。确实和毕业设计比起来（显然是一个不完成的毕业设计），不管在公司的流程上还是一些知识上都学到很多东西，这里做一个小小的总结吧。

#### 页面
页面上的东西其实不用多说，但是第一次使用NODE开发，以为页面可以使用ES6这样的新东西，可惜的是，还是不行，必须兼容IE8（悄悄地说，其实在开发时候并没有使用IE8自测），公司的用的还是很老很老的jQuery1.7.1😑，虽然页面的开发我没有完全参数（我主要开发NODE对接JAVA的接口），但是到中后期的时候，人手不够，原来的另外两个前端被分出去做其他的了，所以基本上我是接手了整个项目。可能其中有一个前端是刚来的原因（或者人家问了我没看到😑）,页面基本所有的AJAX请求的部分里面的模板全是写在JS里面的，😑一个页面的脚本达到了四五百行，后面测试修改BUG的时候也不得不说是一件痛苦的事情，其中在一个页面用到了`window.localStorage`，这个东西。说实话，光顾着修改BUG，没有仔细了解，只是知道有个`localStorage`和`sessionStorage`，这两个东西。其中呢

> 存储在 localStorage 里面的数据没有过期时间（expiration time），而存储在 sessionStorage 里面的数据会在浏览器会话（browsing session）结束时被清除，即浏览器关闭时。 --[window.localStorage](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/localStorage)

这么个概念，好吧，既然以前那个前端的使用的`window.localStorage`，那就顺着改吧。其实主要使用到的也就是：

```JavaScript
window.localStorage.setItem();//存值
window.localStorage.removeItem();//删值
window.localStorage.clear();//删除所有存储的东西
```

这么三个方法，其实在这里的时候遇到一个问题，发现有一些Chrome的插件会存一些数据在`window.localStorage`里面，导致我再页面最开始加载的时候使用`JSON.parse()`解析`window.localStorage`数据的时候会发生错误，然而如果我每次都使用`window.localStorage.clear()`全部干掉的话，也是不好的，所以最终使用了一个`try{}catch(){}`勉强算解决了。而且在这个过程中，我发现如果IE8是在标准文档模式下的话是可以执行`JSON.parse()`的，所以这里我就没有作细看了（请原谅我极度嫌弃IE8）。

还有一个比较重要的问题就是，JAVA在传输数据的时候，传到页面上数据太多，无用的数据（提交的时候要提交回去），同时页面的模板和JS混合在一起，极大的提升了修改的难度（千万不能这样做😌)。

#### NODE
关于NODE，那说的可就多了，毕竟第一次搞完成项目，同时使用的是公司框架（老实说，公司框架--老框架，目前开发了一个新的，还没用过）并不是很好用，文档缺失（写了一半多吧），框架与框架之间的升级太突然，所以几乎是摸索着前进。

##### 框架核心概念
框架只要是调用JAVA的Dubbo服务，从接口获取数据（这里不得不吐槽一下，开发过程的Dubbo之不稳定，有时候一直掉，貌似是Zookeeper的问题，这里我就不是很清楚了）。在NODE中使用`Promise`进行对接口的异步调用，然后获取数据处理。大概看了一下框架中封装的`Promise`，可以传多个接口进去（以数据的形式），然后遍历调用，不好做评价（因为我也是菜鸡😂）。

##### 无及附加的蛋疼过程--session&cookie
这里主要就是状态以及数据的保存的问题了（不得不说，这里也有自己的一些原因，以为自己是老司机，结果没想到一发动就翻车了😂）。

* Session ： 最开始，也就是项目的启动初期，本来是商量使用`redis`来存储数据的，但是后来又说`redis`服务不够，就放弃了。因为我主要是写NODE接口，但是JAVA需要的数据又太多（包括很多无用的数据，据说是为了后期好扩展）。所以最开始，是让页面值传一些数据的关键ID给我，然后由我来进行数据的筛选与拼装，不得不说，NODE能使用ES6真的是太好了，`for...of`帮了很大忙（因为使用NODE版本为4.2.x，所以有些语法不支持，比如解构，也没有使用`Babel`）。然后在测试过程中，问题就浮现出来了，在保存用户提交的数据的时候，也就是那一坨ID的时候，我是直接保存在Session里面的，但是每次刷新页面的时候，页面的数据都是不一样的，所以每次都会重写Session，然而用户的数据没有提交到JAVA的时候，是得保存用户上一次浏览页面是所产生的数据以便好拼装得到用户最终要提交的数据，可是每次重写Session过后，上次浏览产生的数据就不在了，这不行呀，想到存到cookie中，但是数据太多，有可能会超出cookie最大容量（4M左右），这样最后的最后，还是由页面从`window.localStorage`里面拼装并提交所有数据（其实这里还好，只是改得那个过程就不多说了😑）。其次就是在`Promise`中直接修改Session或者频繁的修改Session是无效的，其实这个过程我也没有很清楚的弄明白，在`app.js`的文件中最开始设置session时，有一个属性为`resave`，它的作用是：
> Forces the session to be saved back to the session store, even if the session was never modified during the request. --[express-session](https://www.npmjs.com/package/express-session)

(英语比较渣，就不翻译了😂)把这个`resave`设置为`true`的时候就会发生上述的作用，然后同时把`Promise`里面的session拿出来到外面使用一个变量保存，最后还使用了：
```JavaScript
req.session.save(function(err){
    //session saved
})
```
这个函数（但是好像没产生什么作用）

* cookie ： 这里就花费了比较多的时间了，以前只撸页面的时候天真的以为`document.cookie`嘛，然后把里面需要的数据处理出来就行了，然而并不是。经过一番了解过后，cookie有很多种，在浏览器设置上 Cookie 存在：
  &nbsp;&nbsp;&nbsp;&nbsp;1 httpOnly
  &nbsp;&nbsp;&nbsp;&nbsp;2 session
  &nbsp;&nbsp;&nbsp;&nbsp;3 secure
三种形态，这里简要说一下吧，后面会有一篇（不知道猴年马月能写完的）文章来专门说浏览器中的Session和Cookie。其中如果设置了httpOnly，那么在页面的JS里面是无法通过`document.cookie`来获取的；secure是只有在保证请求为安全请求时才会被发送的，如`HTTPS`；那么`sesseion cookie`，就是在设置cookie的时候没有设置生命周期产生的，只会在浏览器会话结束（应该就是关闭时）才会被删除。
那么问题来了，其中有个需求是在项目中做的登录页里面，有一个注册链接，会跳转到公司主站的公共注册页面去，然后在注册页面注册完成后，会默认变成登录状态，然后通过一个参数，调回到我们项目的页面，并也同时变成登录状态，这里是没问题。问题是在项目下点击登出后，再点击登录页面里面的注册链接时，并不会跳转到注册页，而是直接跳转到主站首页并且为登录状态，当时想到的时候，主站肯定通过cookie某个（或多个值）来保存状态的，果然也是这样，看了php那里得源码（主站的大部分还是用php写的），找到了那两个值，然后我再我的NODE里面，访问我的登出路由时，使用：
```JavaScript
res.cookie('xxx',null,{ maxAge: 0, path: '/'});
```
来清空这两个cookie值，发现并没有成功😑，最开始以为是session cookie的原因，发现那两个cookie值并不是，只是设置了`httpOnly:true`，JS无法操作而已，那为什么不行了，再看cookie的设置域为顶级域名，而我们的项目在三级域名，网上说（应该是准确的，不知道有没有被误导，我查了一些RFC文件也没找到）,子域名对父域名的cookie只读而不可写，当时就很陷入了沉思了，那怎么搞呢，这样没法做啊，最后的最后虽然是使用JAVA提供的一个接口来进行登出状态的清除，但是通过查看Express的文档，发现了`res.cookie`里面的另一个参数`domain`，设置为cookie所在域的话是能清除的，这就比较尴尬了，
```JavaScript
res.cookie('xxx',null,{ maxAge: 0, path: '/', domain: '.xxx.com'});//即可
```

##### 搞服务器的一次成长
我觉得这里是公司做得不好的一个地方，我们开发者，只有开发环境服务器的root权限，而测试服务器（或其他的一些服务器，正式环境不用说了），是只有一些查看权限，而且查看的目录不全，导致一些日志看不到，无法进行高效率的BUG修复。后来发现确实对我来说不好搞，干脆把我生成ssh加入到服务器上，由我自行查看调试，不得不说方便很多了。然而这个过程因为权限不足导致的错误都能讲一个故事了。同时使用Nginx做代理时获取到真实IP的配置过程也加强了一点对Nginx理解，这个过程甚至调用了NODE中原生的OS模块来获取机器的真实IP，确实能获得到，但是IP却是本机的，不符合需求😂。

#### 总结吧(๑•ᴗ•๑)
(我知道这篇文章肯定也有很多错别字😂，再改吧，手速跟不上思维了)总的来说虽然这次完整的NODE踩了很多坑，工期的延期也还好吧（单方面觉得），却是学到很多东西，视角也正从一个页面仔到前后都要顾及的角色转换，算是不错的一次体验。然后又开始搞我的React配合Webpack2重构的简历，这里后面也会有一个总结（搞完了来了，也是遍地是坑😂）。
